<?php

/**
 * @file
 */

use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Entity\Display\EntityViewDisplayInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Component\Serialization\Yaml;

/**
 * Implements hook_form_alter().
 */
function ood_software_form_alter(array &$form, FormStateInterface $form_state, $form_id) {
  // Alter the node edit form for 'software' content type.
  if ($form_id === 'node_appverse_app_edit_form' || $form_id === 'node_appverse_app_form') {
    // Get user roles.
    $user = \Drupal::currentUser();
    $roles = $user->getRoles();

    // Hide fields controlled by repo.
    if (!in_array('administrator', $roles)) {
      $form['body']['#access'] = FALSE;
      $form['field_appverse_readme']['#access'] = FALSE;
      $form['field_appverse_lastupdated']['#access'] = FALSE;
    }

    $form['intro_text'] = [
      '#type' => 'markup',
      '#markup' => '<div class="mb-4">' . t('See the <strong><a href=":url">contributor documentation</a></strong> for best practices in app integration.', [':url' => '#']) . '</div>',
      '#weight' => -10,
    ];

    $form['field_appverse_github_url']['widget'][0]['uri']['#placeholder'] = 'https://github.com/organization/repo';
    unset($form['field_appverse_github_url']['widget'][0]['uri']['#description']);

    // Add prefix/suffix to make the fieldset ajax-replaceable.
    $form['group_github']['#prefix'] = '<div id="edit-group-github">';
    $form['group_github']['#suffix'] = '</div>';

    // Place the button right after the github url field.
    $lookup_button_weight = $form['field_appverse_github_url']['#weight'] + 1;

    $form['group_github']['lookup_button'] = [
      '#type' => 'button',
      '#value' => t('Fetch Repo'),
      '#limit_validation_errors' => array(),
      '#weight' => $lookup_button_weight,
      '#attributes' => [
        'class' => [
          'ml-0'
        ],
      ],
      '#ajax' => [
        'callback' => 'ood_software_fetch_github_data',
        'wrapper' => 'edit-group-github',
      ],
    ];

    array_unshift($form['actions']['submit']['#submit'], 'ood_software__edit_submit');
  }
}

/**
 * Ajax call to pull in Github data.
 */
function ood_software_fetch_github_data(array &$form, FormStateInterface $form_state) {
  $gh = \Drupal::service('ood_software.gh');
  $validUrl = $gh->parseUrl($form_state->getValue('field_appverse_github_url')[0]['uri']);
  $suffix = '<div class="gh-url-suffix bg-header-gray p-3 mb-3" style="margin-top:-1.9rem;">';
  if ($validUrl) {
    $data = $gh->getData();

    $readme = $gh->getReadme();
    $license = $gh->getLicense();
    $manifest = $gh->getManifestData();
    $organization = $gh->getOrganization();

    if ($readme) {
      $suffix .= '<i class="bi bi-check-lg text-success"></i> ' . t('README') . '<br/>';
    } else {
      $suffix .= '<i class="bi bi-exclamation-triangle-fill text-warning"></i> ' . t('No README detected.') . '<br/>';
    }

    if ($manifest) {
      $suffix .= '<i class="bi bi-check-lg text-success"></i> ' . t('manifest.yml file') . '<br/>';
    } else {
      $suffix .= '<i class="bi bi-exclamation-triangle-fill text-warning"></i> ' . t('No manifest.yml detected.') . '<br/>';
    }

    if ($license) {
      $suffix .= '<i class="bi bi-check-lg text-success"></i> ' . t('LICENSE') . '<br/>';
    } else {
      $suffix .= '<i class="bi bi-exclamation-triangle-fill text-warning"></i> ' . t('No license detected.') . '<br/>';
    }

    if ($manifest) {
      $role = $gh->getRole();
      $suffix .= "<p class='pt-3'><strong>" . t("We've detected the following and pre-populated below:") . "</strong></p>";
      $suffix .= "<p><strong>" . t('Organization: ') . "</strong>$organization</p>";
      if ($role) {
        $suffix .= "<p><strong>" . t('App type:') . "</strong> $role </p>";
      }
    }

    // Also update the form element to reflect the change.
    $form['body']['widget'][0]['value']['#value'] = $gh->getDescription();
    $form['field_appverse_readme']['widget'][0]['value']['#value'] = $readme;
    $form['title']['widget'][0]['value']['#value'] = $gh->getRepoName();
    $form['field_appverse_lastupdated']['widget'][0]['value']['#value'] = $gh->getLastComittedDate();
    $form['field_appvserse_organization']['widget'][0]['target_id']['#value'] = $organization;

  } else {
    $suffix .= '<i class="bi bi-x-lg text-danger"></i> Invalid GitHub URL provided.';
  }

  $suffix .= '</div>';
  $form['field_appverse_github_url']['widget'][0]['uri']['#suffix'] = $suffix;

  return $form['group_github'];

}

/**
 * Form submit handler for science.
 */
function ood_software__edit_submit($form, FormStateInterface $form_state) {
  $body = $form_state->getValue('body')[0]['value'];
  $readme = $form_state->getValue('field_appverse_readme')[0]['value'];
  $lastupdated = $form_state->getValue('field_appverse_lastupdated')[0]['value'];

  // Only update if one of these fields is empty.
  $gh = \Drupal::service('ood_software.gh');
  $validUrl = $gh->parseUrl($form_state->getValue('field_appverse_github_url')[0]['uri']);
  if ($validUrl) {
    $data = $gh->getData();

    if ($lastupdated != $gh->getLastComittedDate()) {
      $form_state->setValue('body', [['value' => $gh->getDescription()]]);
      $form_state->setValue('field_appverse_readme', [['value' => $gh->getReadme()]]);
      $form_state->setValue('field_appverse_lastupdated', [['value' => $gh->getLastComittedDate()]]);
    }
  }
}
