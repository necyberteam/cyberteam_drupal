<?php

/**
 * @file
 */

use Drupal\campuschampions\Plugin\CarnegieCodesLookup;
use Drupal\Component\Render\FormattableMarkup;
use Drupal\Core\Access\AccessResult;
use Drupal\Core\Form\FormStateInterface;
use Drupal\node\Entity\Node;
use Drupal\node\NodeInterface;
use Drupal\user\Entity\User;
use Drupal\views\ResultRow;
use Drupal\views\ViewExecutable;

/**
 *
 */
function campuschampions_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id == 'user_form') {
    $form['field_carnegie_code']['widget'][0]['value']['#autocomplete_route_name'] = 'campuschampions.autocomplete';

    // Add validation for Carnegie code field
    $form['#validate'][] = 'campuschampions_user_form_validate';
  }
  global $user;
  if ($form_id == 'webform_submission_join_campus_champions_add_form') {
    // Prepopulate user fields if logged into an account.
    $user = \Drupal::currentUser();
    if ($user->isAuthenticated()) {
      $account = User::load($user->id());
      $form['elements']['username']['#access'] = FALSE;
      $form['elements']['username']['#default_value'] = $account->name->value;
      $form['elements']['user_first_name']['#access'] = FALSE;
      $form['elements']['user_first_name']['#default_value'] = $account->field_user_first_name->value;
      $form['elements']['user_last_name']['#access'] = FALSE;
      $form['elements']['user_last_name']['#default_value'] = $account->field_user_last_name->value;
      $form['elements']['user_email']['#access'] = FALSE;
      $form['elements']['user_email']['#default_value'] = $account->mail->value;
      $form['elements']['username']['#attributes'] = ['readonly' => 'readonly'];
      $form['elements']['user_first_name']['#attributes'] = ['readonly' => 'readonly'];
      $form['elements']['user_last_name']['#attributes'] = ['readonly' => 'readonly'];
      $form['elements']['user_email']['#attributes'] = ['readonly' => 'readonly'];
    }

    $form['elements']['carnegie_classification']['#autocomplete_route_name'] = 'campuschampions.autocomplete';

    // Reorder form.
    $user_institution = $form['elements']['user_institution'];
    unset($form['elements']['user_institution']);
    $form['elements']['user_institution'] = $user_institution;

    if ($form['#validate'] != 'validate_form') {
      $form['#validate'][] = 'validate_form';
    }
  }

  if ($form_id == 'webform_submission_distributed_experts_network_help_add_form') {
    $form['elements']['institution']['#autocomplete_route_name'] = 'campuschampions.autocomplete';
  }

  if ($form_id == 'user_form') {
    // ksm($form);
    $form['role_change']['widget']['#options']['student'] = 'student-facilitator <i class="fa fa-info-circle" aria-hidden="true" data-toggle="tooltip" title="Student Facilitator"></i>';
    $form['role_change']['widget']['#options']['mentor'] = 'mentor <i class="fa fa-info-circle" aria-hidden="true" data-toggle="tooltip" title="Mentor"></i>';
    $form['role_change']['widget']['#options']['professional_mentor'] = 'regional-facilitator <i class="fa fa-info-circle" aria-hidden="true" data-toggle="tooltip" title="Regional Facilitator"></i>';

    // Hide is_campus_champion field unless you are an admin.
    $roles = \Drupal::currentUser()->getRoles();
    if (!in_array("administrator", $roles)) {
      $form['field_is_cc']['widget']['#access'] = FALSE;
    }

    // Don't allow people to join Campus Champions field unless the is_cc field is checked.
    if ($form['#validate'] != 'validate_user_form') {
      $form['#validate'][] = 'validate_user_form';
    }
  }

  // Don't allow people to register as Campus Champions.
  if ($form_id == 'user_register_form') {
    $form['field_is_cc']['widget']['#access'] = FALSE;
    $options = $form['field_region']['widget']['#options'];
    $form['field_region']['widget']['#options'] = array_filter($options, function ($option) {
      if ($option == 'Campus Champions') {
        return FALSE;
      }
      return TRUE;
    });
  }

  if ($form_id == 'change_pwd_form') {
    $form['actions']['submit']['#submit'][] = 'campuschampions_redirect_to_profile_page_form_submit';
  }

  // Hide Preview button on contact forms.
  $start = 'contact_message';
  if (@substr_compare($form_id, $start, 0, strlen($start)) == 0) {
    $form['actions']['preview']['#access'] = FALSE;
  }
}

if (!function_exists('validate_form')) {

  /**
   *
   */
  function validate_form(array &$form, FormStateInterface $form_state) {
    $user_email = $form_state->getValue('user_email');
    $username = $form_state->getValue('username');

    if (!\Drupal::currentUser()->isAuthenticated()) {
      $ids = \Drupal::entityQuery('user')
        ->condition('mail', $user_email)
        ->accessCheck(FALSE)
        ->execute();

      if (!empty($ids)) {
        $form_state->setErrorByName('user_email', t('There is an account associated with this email address. Please <a href="/user/login">login</a> first.'));
      }

      $uids = \Drupal::entityQuery('user')
        ->condition('name', $username)
        ->accessCheck(FALSE)
        ->execute();

      if (!empty($uids)) {
        $form_state->setErrorByName('username', t('There is an account associated with this username. Please <a href="/user/login">login</a> first.'));
      }
    }
  }

}

/**
 * Implements validate_user_form().
 *
 * Require is_cc field to assign Campus Champions Program.
 */
if (!function_exists('validate_user_form')) {

  /**
   *
   */
  function validate_user_form(array &$form, FormStateInterface $form_state) {
    $programs = $form_state->getValue('field_region');
    $is_cc = $form_state->getValue('field_is_cc');
    // 572 is Campus Champions
    if (array_filter($programs, function ($program) {
      return $program['target_id'] == '572';
    }) && !$is_cc['value']) {
      $form_state->setErrorByName('field_region', t('Please join the Campus Champions by submitting <a href="/form/join-campus-champions">this form</a> before selecting "Campus Champions" in the Programs list.'));
    }
  }

}

/**
 * Implements hook_theme().
 */
function campuschampions_theme() {
  return [
    'campuschampions_block' => [
      'variables' => [
        'data' => [],
      ],
    ],
    'socialauthgoogle' => [
      'template' => 'block--socialauthgoogle',
      'variables' => [
        'destination_path' => '',
      ],
    ],
  ];
}

/**
 * Implements hook_mail().
 *
 * Send mail to approved campus champions.
 */
function campuschampions_mail($key, &$message, $params) {
  $options = [
    'langcode' => $message['langcode'],
  ];
  switch ($key) {
    case 'approve_campuschampion':
      $message['from'] = 'leadership@campuschampions.org';
      $message['subject'] = 'Welcome to the Campus Champions Portal!';
      $message['body'][] = $params['message'];
      break;

    case 'join-cc':
      $message['from'] = 'leadership@campuschampions.org';
      $message['subject'] = $params['title'];
      ;
      $message['body'][] = $params['body'];
      break;
  }
}

/**
 * Implements hook_mail_alter().
 *
 * Allow including html in system messages.
 */
function campuschampions_mail_alter(&$message) {
  switch ($message['key']) {
    // Case 'page_mail':
    // case 'page_copy':
    // case 'cancel_confirm':
    case 'password_reset':
      // Case 'register_admin_created':
      // case 'register_no_approval_required':
      // case 'register_pending_approval':
      // case 'register_pending_approval_admin':
      // case 'status_activated':
      // case 'status_blocked':
      // case 'status_canceled':
    case 'approve_campuschampion':
      $message['headers']['Content-Type'] = 'text/html; charset=UTF-8; format=flowed; delsp=yes';
      foreach ($message['body'] as $key => &$body) {
        $body = new FormattableMarkup($body, []);
      }
      break;

  }
}

/**
 * Implements hook_node_access().
 *
 * Allow Affinity Group coordinators to edit the affinity group node.
 */
function campuschampions_node_access(NodeInterface $node, $op, $account) {
  $type = $node->bundle();

  if ($type != 'affinity_group' || $op != 'update') {
    return AccessResult::neutral();
  }

  $uids = array_column($node->field_coordinator->getValue(), 'target_id');

  return AccessResult::allowedIf(in_array($account->id(), $uids))->cachePerUser()->addCacheableDependency($node);
}

/**
 * Redirect to the profile page after submission.
 */
function campuschampions_redirect_to_profile_page_form_submit($form, &$form_state) {
  $form_state->setRedirect('user.page');
}

/**
 * Implements HOOK_views_data_export_row_alter().
 *
 * Fill out data about the associated intstitution (Carnegie code).
 */
function campuschampions_views_data_export_row_alter(&$row, ResultRow $result, ViewExecutable $view) {
  // Static cache for the Carnegie lookup instance and lat/lon data
  static $carnegie_db = NULL;
  static $org_locations = NULL;

  if ($view->id() == 'campus_champions_user_export' && $view->current_display == 'ccusers_data_export') {

    $cc = (string) $row['field_carnegie_code'];

    $row['field_carnegie_code'] = t('');
    $row['field_carnegie_code_location'] = '';
    $row['field_carnegie_code_classification'] = '';
    $row['field_carnegie_code_hbcu'] = '';
    $row['field_carnegie_code_pbi'] = '';
    $row['field_carnegie_code_annhsi'] = '';
    $row['field_carnegie_code_tribal'] = '';
    $row['field_carnegie_code_aanapisi'] = '';
    $row['field_carnegie_code_hsi'] = '';
    $row['field_carnegie_code_nasnti'] = '';
    $row['field_carnegie_code_site'] = '';
    $row['field_carnegie_code_eps_lookup'] = '';
    $row['field_carnegie_code_type_id'] = '';
    $row['field_carnegie_code_type'] = '';
    $row['field_carnegie_code_region'] = '';
    $row['field_carnegie_code_lat'] = '';
    $row['field_carnegie_code_lon'] = '';

    // Only get Carnegie data if a code exists - don't try to populate missing ones.
    if (!empty($cc)) {
      // Initialize static caches
      if ($carnegie_db === NULL) {
        $carnegie_db = new CarnegieCodesLookup(\Drupal::database());
      }
      if ($org_locations === NULL) {
        $org_locations = [];
      }

      // Get data based on carnegie code.
      $db = $carnegie_db;
      $results = $db->lookupByUnitId($cc, [
        'instnm',
        'city',
        'stabbr',
        'ic2025',
        'ic2025name',
        'hbcu',
        'pbi',
        'annhsi',
        'tribal',
        'aanapisi',
        'hsi',
        'nasnti',
        'msi',
      ]);

      if ($results !== FALSE) {
        $row['field_carnegie_code'] = $cc;
        $row['field_carnegie_code_location'] = $results['city'] . ', ' . $results['stabbr'];
        $row['field_carnegie_code_classification'] = $results['ic2025name'];
        $row['field_carnegie_code_hbcu'] = $results['hbcu'];
        $row['field_carnegie_code_pbi'] = $results['pbi'];
        $row['field_carnegie_code_annhsi'] = $results['annhsi'];
        $row['field_carnegie_code_tribal'] = $results['tribal'];
        $row['field_carnegie_code_aanapisi'] = $results['aanapisi'];
        $row['field_carnegie_code_hsi'] = $results['hsi'];
        $row['field_carnegie_code_nasnti'] = $results['nasnti'];
        $row['field_carnegie_code_site'] = $results['instnm'];
        $row['field_carnegie_code_region'] = CarnegieCodesLookup::region($results['stabbr']);

        $row['field_carnegie_code_eps_lookup'] = 0;
        if (CarnegieCodesLookup::isEpscor($results['stabbr'])) {
          $row['field_carnegie_code_eps_lookup'] = 1;
        }

        $row['field_carnegie_code_type_id'] = CarnegieCodesLookup::typeId(
          $row['field_carnegie_code_hbcu'],
          $row['field_carnegie_code_pbi'],
          $row['field_carnegie_code_annhsi'],
          $row['field_carnegie_code_tribal'],
          $row['field_carnegie_code_aanapisi'],
          $row['field_carnegie_code_hsi'],
          $row['field_carnegie_code_nasnti'],
          $row['field_carnegie_code_eps_lookup'],
          $row['field_carnegie_code']
        );
        $row['field_carnegie_code_type'] = CarnegieCodesLookup::type($row['field_carnegie_code_type_id']);

        // Try to retrieve the LAT and LON from the ACCESS organization (with caching)
        if (isset($org_locations[$cc])) {
          // Use cached values
          $row['field_carnegie_code_lat'] = $org_locations[$cc]['lat'];
          $row['field_carnegie_code_lon'] = $org_locations[$cc]['lon'];
        } else {
          // Look it up and cache it
          $nids = \Drupal::entityQuery('node')
            ->condition('type', 'access_organization')
            ->condition('field_carnegie_code', $cc, '=')
            ->range(0, 1)
            ->accessCheck(FALSE)
            ->execute();

          if (!empty($nids)) {
            $rows = Node::loadMultiple($nids);
            foreach ($rows as $org) {
              $lat = $org->field_latitude ? $org->field_latitude->value : NULL;
              $lon = $org->field_longitude ? $org->field_longitude->value : NULL;
              $row['field_carnegie_code_lat'] = $lat;
              $row['field_carnegie_code_lon'] = $lon;
              // Cache for future rows
              $org_locations[$cc] = ['lat' => $lat, 'lon' => $lon];
            }
          } else {
            // Cache that we found nothing for this code
            $org_locations[$cc] = ['lat' => NULL, 'lon' => NULL];
          }
        }
      }
    }

    // Designation.
    if (!isset($row['webform_submission_value']) || !$row['webform_submission_value']) {
      $row['webform_submission_value'] = 'Champion';
    }
  }
}

/**
 * Implements hook_views_pre_view().
 */
function campuschampions_views_pre_view(ViewExecutable $view, $display_id, array &$args) {
  if ($view->id() == 'access_news' && $display_id === 'block_1') {
    $view_filters = $view->display_handler->getOption('filters');
    $domain = \Drupal::service('access_misc.sitetools')->getDomainId();

    $view_filters['field_domain_access_target_id']['value'] = [];
    $view_filters['field_domain_access_target_id']['value'][$domain] = $domain;

    //field_domain_access_target_id
    $view->display_handler->setOption('filters', $view_filters);
  }
}

/**
 * Validate Carnegie code field on user forms.
 */
function campuschampions_user_form_validate(array &$form, \Drupal\Core\Form\FormStateInterface $form_state) {
  $carnegie_code = $form_state->getValue('field_carnegie_code');

  if (!empty($carnegie_code) && !empty($carnegie_code[0]['value'])) {
    $code = $carnegie_code[0]['value'];

    // Validate that the Carnegie code exists in the database
    $query = \Drupal::database()
      ->select('carnegie_codes', 'cc')
      ->fields('cc', ['unitid'])
      ->condition('unitid', $code, '=')
      ->range(0, 1);

    $result = $query->execute()->fetchField();

    if (empty($result)) {
      $form_state->setErrorByName('field_carnegie_code', t('The Carnegie code "@code" is not valid. Please enter a valid Carnegie classification code or leave blank for non-academic institutions.', ['@code' => $code]));
    }
  }
}

/**
 * Implements hook_cron().
 */
function campuschampions_cron() {
  // Update Campus Champions stats once per day.
  $currentTime = \Drupal::time()->getCurrentTime();
  $lastRun = \Drupal::state()->get('cc_stats_last_update', 0);

  // Run if it's been more than 24 hours since last update
  $secondsSinceLastRun = $currentTime - $lastRun;
  $hoursInterval = 24; // Update every 24 hours

  if ($secondsSinceLastRun >= ($hoursInterval * 3600)) {
    \Drupal::logger('campuschampions')->info('Updating Campus Champions stats via cron');
    \Drupal::service('cc.getStats')->setState();
    \Drupal::state()->set('cc_stats_last_update', $currentTime);
  }
}
