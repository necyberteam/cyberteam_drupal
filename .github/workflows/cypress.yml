name: (M) Cypress Tests
on:
  pull_request:
  workflow_dispatch:
    inputs:
      database:
        description: 'Recent database dump to use (leave blank to use artifact)'
      sites:
        description: 'Specify which sites to test or leave the default to run all tests.'
        default: 'accessmatch1, accessmatch2, ccmnet, connectci, crct, campuschampions, coco, greatplains, kyct, nect'
        required: true
      prnum:
        description: 'Pull request number â€” adds a comment to a pull request (nomally empty)'

permissions:
  contents: write
  actions: read
  pull-requests: write

jobs:
  accessmatch1:
    name: Run cypress tests in 'accessmatch1' directory
    uses: necyberteam/reusable_actions/.github/workflows/cypress.yml@v3.2
    if: contains(github.event.inputs.sites, 'accessmatch1') || github.event_name == 'pull_request'
    secrets:
      slack_token: ${{ secrets.SLACK_TOKEN }}
      site: "accessmatch1"
      database: ${{ github.event.inputs.database }}
      prnum: ${{ github.event.inputs.prnum }}
      gh_token: ${{ secrets.GH_TOKEN_REPO }}
      LANDO_ENV: ${{ secrets.LANDO_ENV }}
      SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
      REPO: "${{ github.server_url }}/${{ github.repository }}"

  accessmatch2:
    name: Run cypress tests in 'accessmatch2' directory
    uses: necyberteam/reusable_actions/.github/workflows/cypress.yml@v3.2
    if: contains(github.event.inputs.sites, 'accessmatch2') || github.event_name == 'pull_request'
    secrets:
      slack_token: ${{ secrets.SLACK_TOKEN }}
      site: "accessmatch2"
      database: ${{ github.event.inputs.database }}
      prnum: ${{ github.event.inputs.prnum }}
      gh_token: ${{ secrets.GH_TOKEN_REPO }}
      LANDO_ENV: ${{ secrets.LANDO_ENV }}
      SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
      REPO: "${{ github.server_url }}/${{ github.repository }}"

  ccmnet:
    name: Run cypress tests in 'ccmnet' directory
    uses: necyberteam/reusable_actions/.github/workflows/cypress.yml@v3.2
    if: contains(github.event.inputs.sites, 'ccmnet') || github.event_name == 'pull_request'
    secrets:
      slack_token: ${{ secrets.SLACK_TOKEN }}
      site: "ccmnet"
      database: ${{ github.event.inputs.database }}
      prnum: ${{ github.event.inputs.prnum }}
      gh_token: ${{ secrets.GH_TOKEN_REPO }}
      LANDO_ENV: ${{ secrets.LANDO_ENV }}
      SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
      REPO: "${{ github.server_url }}/${{ github.repository }}"

  connectci:
    name: Run cypress tests in 'connectci' directory
    uses: necyberteam/reusable_actions/.github/workflows/cypress.yml@v3.2
    if: contains(github.event.inputs.sites, 'connectci') || github.event_name == 'pull_request'
    secrets:
      slack_token: ${{ secrets.SLACK_TOKEN }}
      site: "connectci"
      database: ${{ github.event.inputs.database }}
      prnum: ${{ github.event.inputs.prnum }}
      gh_token: ${{ secrets.GH_TOKEN_REPO }}
      LANDO_ENV: ${{ secrets.LANDO_ENV }}
      SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
      REPO: "${{ github.server_url }}/${{ github.repository }}"

  crct:
    name: Run cypress tests in 'crct' directory
    uses: necyberteam/reusable_actions/.github/workflows/cypress.yml@v3.2
    if: contains(github.event.inputs.sites, 'crct') || github.event_name == 'pull_request'
    secrets:
      slack_token: ${{ secrets.SLACK_TOKEN }}
      site: "crct"
      database: ${{ github.event.inputs.database }}
      prnum: ${{ github.event.inputs.prnum }}
      gh_token: ${{ secrets.GH_TOKEN_REPO }}
      LANDO_ENV: ${{ secrets.LANDO_ENV }}
      SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
      REPO: "${{ github.server_url }}/${{ github.repository }}"

  campuschampions:
    name: Run cypress tests in 'campuschampions' directory
    uses: necyberteam/reusable_actions/.github/workflows/cypress.yml@v3.2
    if: contains(github.event.inputs.sites, 'campuschampions') || github.event_name == 'pull_request'
    secrets:
      slack_token: ${{ secrets.SLACK_TOKEN }}
      site: "campuschampions"
      database: ${{ github.event.inputs.database }}
      prnum: ${{ github.event.inputs.prnum }}
      gh_token: ${{ secrets.GH_TOKEN_REPO }}
      LANDO_ENV: ${{ secrets.LANDO_ENV }}
      SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
      REPO: "${{ github.server_url }}/${{ github.repository }}"
  coco:
    name: Run cypress tests in 'coco' directory
    uses: necyberteam/reusable_actions/.github/workflows/cypress.yml@v3.2
    if: contains(github.event.inputs.sites, 'coco') || github.event_name == 'pull_request'
    secrets:
      slack_token: ${{ secrets.SLACK_TOKEN }}
      site: "coco"
      database: ${{ github.event.inputs.database }}
      prnum: ${{ github.event.inputs.prnum }}
      gh_token: ${{ secrets.GH_TOKEN_REPO }}
      LANDO_ENV: ${{ secrets.LANDO_ENV }}
      SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
      REPO: "${{ github.server_url }}/${{ github.repository }}"

  greatplains:
    name: Run cypress tests in 'greatplains' directory
    uses: necyberteam/reusable_actions/.github/workflows/cypress.yml@v3.2
    if: contains(github.event.inputs.sites, 'greatplains') || github.event_name == 'pull_request'
    secrets:
      slack_token: ${{ secrets.SLACK_TOKEN }}
      site: "greatplains"
      database: ${{ github.event.inputs.database }}
      prnum: ${{ github.event.inputs.prnum }}
      gh_token: ${{ secrets.GH_TOKEN_REPO }}
      LANDO_ENV: ${{ secrets.LANDO_ENV }}
      SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
      REPO: "${{ github.server_url }}/${{ github.repository }}"

  kyct:
    name: Run cypress tests in 'kyct' directory
    uses: necyberteam/reusable_actions/.github/workflows/cypress.yml@v3.2
    if: contains(github.event.inputs.sites, 'kyct') || github.event_name == 'pull_request'
    secrets:
      slack_token: ${{ secrets.SLACK_TOKEN }}
      site: "kyct"
      database: ${{ github.event.inputs.database }}
      prnum: ${{ github.event.inputs.prnum }}
      gh_token: ${{ secrets.GH_TOKEN_REPO }}
      LANDO_ENV: ${{ secrets.LANDO_ENV }}
      SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
      REPO: "${{ github.server_url }}/${{ github.repository }}"

  nect:
    name: Run cypress tests in 'nect' directory
    uses: necyberteam/reusable_actions/.github/workflows/cypress.yml@v3.2
    if: contains(github.event.inputs.sites, 'nect') || github.event_name == 'pull_request'
    secrets:
      slack_token: ${{ secrets.SLACK_TOKEN }}
      site: "nect"
      database: ${{ github.event.inputs.database }}
      prnum: ${{ github.event.inputs.prnum }}
      gh_token: ${{ secrets.GH_TOKEN_REPO }}
      LANDO_ENV: ${{ secrets.LANDO_ENV }}
      SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
      REPO: "${{ github.server_url }}/${{ github.repository }}"


  # success:
  #   name: Actions to run on success
  #   needs: [asp]
  #   if: ${{ success() || ( always() && ! cancelled() && ! failure() ) }}
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Comment on pull request
  #       if: "${{ env.prnum  != '' }}"
  #       run: |
  #         gh pr comment $prnum -R $REPO --body "ðŸ¤– -=-=-=- Cypress Test was Successful -=-=-=- ðŸ¤–"
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #         prnum: ${{ github.event.inputs.prnum }}
  #         REPO: "${{ github.server_url }}/${{ github.repository }}"
  #     - name: Slack Notification Success
  #       uses: rtCamp/action-slack-notify@v2
  #       env:
  #         SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
  #         SLACK_MESSAGE: 'ðŸ¤– -=-=-=- Cypress Test Succeeded -=-=-=- ðŸ¤–'
  #         SLACK_TITLE: "Cypress tests passed"
  #         SLACK_CHANNEL: cypress-git-notifications

  fail:
    name: Actions to run on fail
    needs: [accessmatch1, accessmatch2, ccmnet, connectci, crct, campuschampions, coco, greatplains, kyct, nect]
    if:  ${{ failure() }}
    runs-on: ubuntu-latest
    steps:
      - name: Comment on pull request
        if: "${{ env.prnum  != '' }}"
        run: |
          gh pr comment $prnum -R $REPO --body "ðŸ¤– -=-=-=- Cypress Test has failed ðŸ˜© -=-=-=- ðŸ¤–"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          prnum: ${{ github.event.inputs.prnum }}
          REPO: "${{ github.server_url }}/${{ github.repository }}"
      - name: Slack Notification Success
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_MESSAGE: 'ðŸ¤– -=-=-=- Cypress Test Failed -=-=-=- ðŸ¤–'
          SLACK_TITLE: "Cypress tests failed"
          SLACK_CHANNEL: cypress-git-notifications
